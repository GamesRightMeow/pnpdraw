<!DOCTYPE html>
<html>
  <head>
    <title>PNP Draw</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style type='text/css'>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0px;
        height: 100vh;
        width: 100vw;
        overflow-y: hidden;
        overflow-x: hidden;
      }
      #container {
        display: flex;
      }
      #sheet {
        border: 2px solid black;
        width: 100%;
        height: 100%;
      }
      #toolbar {
        display: flex;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="toolbar">
        <input id="userImage" type="file">
        <button id="drawButton">Draw</button>
        <button id="eraseButton">Erase</button>
        <div id="debug">1</div>
      </div>

      <canvas id="sheet"></canvas>

      <script type='text/javascript'>
        let debug = document.getElementById('debug');
        debug.innerText = "TEST";

        let canvas = document.getElementById('sheet');
        canvas.width = document.body.clientWidth
        canvas.height = document.body.clientHeight

        let context = canvas.getContext("2d");

        let userImg = new Image;
        let imageInput = document.getElementById('userImage');
        imageInput.onchange = (e) => {
          userImg.onload = function() {
            redraw()
          }
          userImg.src = URL.createObjectURL(e.target.files[0]);
        };
        
        context.lineJoin = "round";
        context.lineWidth = 2;

        let clickX = [];
        let clickY = [];
        let clickDrag = [];
        let paint = false;
        let pan = false;
        let panOffset = { x: 0, y: 0 };
        let lastPanPos = { x: 0, y: 0 };
        let scale = 1;
        let lastScaleDistance = 0;

        /**
         * Add information where the user clicked at.
         * @param {number} x
         * @param {number} y
         * @return {boolean} dragging
         */
        function addClick(x, y, dragging) {
          clickX.push(x);
          clickY.push(y);
          clickDrag.push(dragging);
        }

        /**
         * Redraw the complete canvas.
         */
        function redraw() {
          // Clears the canvas
          context.setTransform(1, 0, 0, 1, 0, 0);

          // context.clearRect(0, 0, context.canvas.width, context.canvas.height);
          context.fillStyle = "#FF0000";
          context.fillRect(0, 0, context.canvas.width, context.canvas.height);

          context.scale(scale, scale);
          context.translate(panOffset.x, panOffset.y);

          context.drawImage(userImg, 0, 0);

          context.strokeStyle = "#000000";
          for (let i = 0; i < clickX.length; i += 1) {
            if (!clickDrag[i] && i == 0) {
              context.beginPath();
              context.moveTo(clickX[i], clickY[i]);
              context.stroke();
            } else if (!clickDrag[i] && i > 0) {
              context.closePath();

              context.beginPath();
              context.moveTo(clickX[i], clickY[i]);
              context.stroke();
            } else {
              context.lineTo(clickX[i], clickY[i]);
              context.stroke();
            }
          }
        }

        /**
         * Draw the newly added point.
         * @return {void}
         */
        function drawNew() {
          let i = clickX.length - 1
          if (!clickDrag[i]) {
            if (clickX.length == 0) {
              context.beginPath();
              context.moveTo(clickX[i], clickY[i]);
              context.stroke();
            } else {
              context.closePath();

              context.beginPath();
              context.moveTo(clickX[i], clickY[i]);
              context.stroke();
            }
          } else {
            context.lineTo(clickX[i], clickY[i]);
            context.stroke();
          }
        }

        function mouseDownEventHandler(e) {
          let x = e.pageX - canvas.offsetLeft;
          let y = e.pageY - canvas.offsetTop;

          if (e.buttons == 1) {
            paint = true;
            addClick(x - panOffset.x, y - panOffset.y, false);
            drawNew();
          } else if (e.buttons == 2) {
            pan = true;
            lastPanPos.x = x;
            lastPanPos.y = y;
          }
        }

        function touchstartEventHandler(e) {
          paint = true;
          let x1 = e.touches[0].pageX - canvas.offsetLeft;
          let y1 = e.touches[0].pageY - canvas.offsetTop;

          if (e.touches.length > 1) {
            let x2 = e.touches[1].pageX - canvas.offsetLeft;
            let y2 = e.touches[1].pageY - canvas.offsetTop;
            let midX = (x1 + x2)/2;
            let midY = (y1 + y2)/2;
            lastPanPos.x = midX;
            lastPanPos.y = midY;
            lastScaleDistance = Math.abs((x2 - x1) + (y2 - y1));
          }

          addClick(x1 - panOffset.x, y1 - panOffset.y, false);
          drawNew();
        }

        function mouseUpEventHandler(e) {
          context.closePath();
          paint = false;
          pan = false;
        }

        function mouseMoveEventHandler(e) {
          let x = e.pageX - canvas.offsetLeft;
          let y = e.pageY - canvas.offsetTop;
          
          if (paint) {
            addClick(x - panOffset.x, y - panOffset.y, true);
            drawNew();
          }

          if (pan) {
            let dx = x - lastPanPos.x;
            let dy = y - lastPanPos.y;
            let sens = (1.0 - scale) * 4;
            panOffset.x += dx * (1 + sens);
            panOffset.y += dy * (1 + sens);
            lastPanPos.x = x;
            lastPanPos.y = y;
            redraw();
          }
        }

        function mouseWheelHandler(e) {
          let dir = Math.sign(e.wheelDelta);
          scale = Math.min(1, Math.max(0.01, scale + dir * 0.01));
          redraw();
        }

        function mouseLeaveHandler(e) {
          paint = false;
          pan = false;
        }

        function touchMoveEventHandler(e) {
          let x1 = e.touches[0].pageX - canvas.offsetLeft;
          let y1 = e.touches[0].pageY - canvas.offsetTop;
          if (e.touches.length == 1) {
            if (paint) {
              addClick(x1 - panOffset.x, y1 - panOffset.y, true);
              drawNew();
            }
          } else {
            let x2 = e.touches[1].pageX - canvas.offsetLeft;
            let y2 = e.touches[1].pageY - canvas.offsetTop;
            let midX = (x1 + x2)/2;
            let midY = (y1 + y2)/2;

            let dx = midX - lastPanPos.x
            let dy = midY - lastPanPos.y
            let sens = (1.0 - scale) * 4;
            panOffset.x += dx * (1 + sens);
            panOffset.y += dy * (1 + sens);
            lastPanPos.x = midX;
            lastPanPos.y = midY;
            
            let distance = Math.abs((x2 - x1) + (y2 - y1));
            let ds = distance - lastScaleDistance;
            if (Math.abs(ds) > 10) {
              ds -= 10 * Math.sign(ds);
              scale = Math.min(1, Math.max(0.01, scale + (ds * 0.0025)));
              lastScaleDistance = distance;
            }
            debug.innerText = ds;

            redraw();
          }
        }

        function setUpHandler(isMouseandNotTouch, detectEvent) {
          removeRaceHandlers();
          if (isMouseandNotTouch) {
            canvas.addEventListener('mouseup', mouseUpEventHandler);
            canvas.addEventListener('mousemove', mouseMoveEventHandler);
            canvas.addEventListener('mousedown', mouseDownEventHandler);
            canvas.addEventListener('mouseleave', mouseLeaveHandler);
            canvas.addEventListener('wheel', mouseWheelHandler);
            // disable opening context menu
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());
            mouseDownEventHandler(detectEvent);
          } else {
            canvas.addEventListener('touchstart', touchstartEventHandler);
            canvas.addEventListener('touchmove', touchMoveEventHandler);
            canvas.addEventListener('touchend', mouseUpEventHandler);
            touchstartEventHandler(detectEvent);
          }
        }

        function mouseWins(e) {
          setUpHandler(true, e);
        }

        function touchWins(e) {
          setUpHandler(false, e);
        }

        function removeRaceHandlers() {
          canvas.removeEventListener('mousedown', mouseWins);
          canvas.removeEventListener('touchstart', touchWins);
        }

        canvas.addEventListener('mousedown', mouseWins);
        canvas.addEventListener('touchstart', touchWins);
      </script>
    </div>
  </body>
</html>