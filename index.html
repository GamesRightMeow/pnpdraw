<!DOCTYPE html>
<html>
  <head>
    <title>PNP Draw</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style type='text/css'>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0px;
        height: 100vh;
        width: 100vw;
        overflow-y: hidden;
        overflow-x: hidden;
      }
      #container {
        display: flex;
      }
      #sheet {
        border: 2px solid black;
        width: 100%;
        height: 100%;
      }
      #toolbar {
        display: flex;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="toolbar">
        <input id="userImage" type="file">
        <button id="drawButton">Draw</button>
        <button id="eraseButton">Erase</button>
        <div id="debug">1</div>
      </div>

      <canvas id="sheet"></canvas>

      <script type='text/javascript'>
        let debug = document.getElementById('debug');
        debug.innerText = "TEST";

        let mainCanvas = document.getElementById('sheet');
        mainCanvas.width = document.body.clientWidth
        mainCanvas.height = document.body.clientHeight
        let mainContext = mainCanvas.getContext("2d");
        
        var drawCanvas = document.createElement('canvas');
        drawCanvas.width = mainCanvas.width;
        drawCanvas.height = mainCanvas.height;
        let drawContext = drawCanvas.getContext("2d");

        let userImg = new Image;
        let imageInput = document.getElementById('userImage');
        imageInput.onchange = (e) => {
          userImg.onload = function() {
            redraw()
          }
          userImg.src = URL.createObjectURL(e.target.files[0]);
        };
        
        mainContext.lineJoin = "round";
        mainContext.lineWidth = 2;

        let paint = false;
        let pan = false;
        let panOffset = { x: 0, y: 0 };
        let lastPanPos = { x: 0, y: 0 };
        let scale = 1;
        let lastScaleDis = 0;
        let pinchMode = false;
        let lastChangeTime = Date.now();

        /**
         * Redraw the complete canvas.
         */
        function redraw() {
          mainContext.setTransform(1, 0, 0, 1, 0, 0);

          mainContext.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
          
          mainContext.fillStyle = "#FF0000";
          mainContext.strokeStyle = "#000000";

          mainContext.scale(scale, scale);
          mainContext.translate(panOffset.x, panOffset.y);

          mainContext.drawImage(userImg, 0, 0);
          mainContext.drawImage(drawCanvas, 0, 0)
        }

        function drawClick(x, y, drag) {
          if (!drag && index == 0) {
            drawContext.beginPath();
            drawContext.moveTo(x, y);
            drawContext.stroke();
          } else if (!drag && index > 0) {
            drawContext.closePath();
            drawContext.beginPath();
            drawContext.moveTo(x, y);
            drawContext.stroke();
          } else {
            drawContext.lineTo(x, y);
            drawContext.stroke();
          }
        }

        function mouseDownEventHandler(e) {
          let x = e.pageX - mainCanvas.offsetLeft;
          let y = e.pageY - mainCanvas.offsetTop;

          if (e.buttons == 1) {
            paint = true;
            drawContext.beginPath();
            drawContext.moveTo(x, y);
            drawContext.stroke();
            redraw();
          } else if (e.buttons == 2) {
            pan = true;
            lastPanPos.x = x;
            lastPanPos.y = y;
          }
        }

        function touchstartEventHandler(e) {
          paint = true;
          pinchMode = 0;
          let x1 = e.touches[0].pageX - mainCanvas.offsetLeft;
          let y1 = e.touches[0].pageY - mainCanvas.offsetTop;

          if (e.touches.length > 1) {
            let x2 = e.touches[1].pageX - mainCanvas.offsetLeft;
            let y2 = e.touches[1].pageY - mainCanvas.offsetTop;
            let midX = (x1 + x2)/2;
            let midY = (y1 + y2)/2;
            lastPanPos.x = midX;
            lastPanPos.y = midY;
            lastScaleDis = Math.hypot(x2 - x1, y2 - y1);
          } else {
            drawContext.beginPath();
            drawContext.moveTo(x1, y1);
            drawContext.stroke();
            redraw();
          }
        }

        function touchEndEventHandler(e) {
          drawContext.closePath();
          paint = false;
          pan = false;
        }

        function mouseUpEventHandler(e) {
          drawContext.closePath();
          paint = false;
          pan = false;
        }

        function mouseMoveEventHandler(e) {
          let x = e.pageX - mainCanvas.offsetLeft;
          let y = e.pageY - mainCanvas.offsetTop;
          
          if (paint) {
            drawContext.lineTo(x, y);
            drawContext.stroke();
            redraw();
          }

          if (pan) {
            let dx = x - lastPanPos.x;
            let dy = y - lastPanPos.y;
            let sens = (1.0 - scale) * 4;
            panOffset.x += dx * (1 + sens);
            panOffset.y += dy * (1 + sens);
            lastPanPos.x = x;
            lastPanPos.y = y;
            redraw();
          }
        }

        function touchMoveEventHandler(e) {
          let x1 = e.touches[0].pageX - mainCanvas.offsetLeft;
          let y1 = e.touches[0].pageY - mainCanvas.offsetTop;
          if (e.touches.length == 1) {
            if (paint) {
              drawContext.lineTo(x1, y1);
              drawContext.stroke();
              redraw();
            }
          } else {
            let x2 = e.touches[1].pageX - mainCanvas.offsetLeft;
            let y2 = e.touches[1].pageY - mainCanvas.offsetTop;
            
            let midX = (x1 + x2)/2;
            let midY = (y1 + y2)/2;
            let panDis = Math.hypot(midX - lastPanPos.x, midY - lastPanPos.y);

            let scaleDis = Math.hypot(x2 - x1, y2 - y1);
            let deltaScaleDis = scaleDis - lastScaleDis;

            // act on mode
            if (pinchMode == 0) {

            } else if (pinchMode == 1) {
              // pan
              let dx = midX - lastPanPos.x
              let dy = midY - lastPanPos.y
              let sens = (1.0 - scale) * 4;
              panOffset.x += dx * (1 + sens);
              panOffset.y += dy * (1 + sens);
            } else if (pinchMode == 2) {
              // zoom
              scale = Math.min(1, Math.max(0.01, scale + (deltaScaleDis * 0.0025)));
            }

            lastScaleDis = scaleDis;
            lastPanPos.x = x1;
            lastPanPos.y = y1;

            redraw();
          }
        }

        function mouseWheelEventHandler(e) {
          let dir = Math.sign(e.wheelDelta);
          scale = Math.min(1, Math.max(0.01, scale + dir * 0.01));
          redraw();
        }

        function mouseLeaveEventHandler(e) {
          paint = false;
          pan = false;
        }

        function mouseWins(e) {
          mainCanvas.removeEventListener('mousedown', mouseWins);
          mainCanvas.removeEventListener('touchstart', touchWins);

          mainCanvas.addEventListener('mouseup', mouseUpEventHandler);
          mainCanvas.addEventListener('mousemove', mouseMoveEventHandler);
          mainCanvas.addEventListener('mousedown', mouseDownEventHandler);
          mainCanvas.addEventListener('mouseleave', mouseLeaveEventHandler);
          mainCanvas.addEventListener('wheel', mouseWheelEventHandler);

          // disable opening context menu
          mainCanvas.addEventListener('contextmenu', (e) => e.preventDefault());

          mouseDownEventHandler(e);
        }

        function touchWins(e) {
          mainCanvas.removeEventListener('mousedown', mouseWins);
          mainCanvas.removeEventListener('touchstart', touchWins);

          mainCanvas.addEventListener('touchstart', touchstartEventHandler);
          mainCanvas.addEventListener('touchmove', touchMoveEventHandler);
          mainCanvas.addEventListener('touchend', touchEndEventHandler);

          touchstartEventHandler(e);
        }

        mainCanvas.addEventListener('mousedown', mouseWins);
        mainCanvas.addEventListener('touchstart', touchWins);
      </script>
    </div>
  </body>
</html>